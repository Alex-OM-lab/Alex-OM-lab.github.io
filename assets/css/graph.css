/* ===== ÁRBOL VISUAL (SVG) ===== */
.graph .card{
  border-radius: var(--radius);
  border:1px solid rgba(255,255,255,.06);
  background:linear-gradient(180deg,color-mix(in oklab,var(--panel) 92%,#0f1422 8%),var(--panel));
  padding:14px;
}
.graph-head{ display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin-bottom:10px; }
.graph-head h2{ margin:0 }

/* Botón (ahora: encender/apagar panel) */
.theme-toggle{
  appearance:none; border:1px solid rgba(255,255,255,.12); background:#0e1730;
  color:var(--text); padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer;
  transition:transform .15s ease, background .2s ease, border-color .2s ease;
}
.theme-toggle:hover{ transform:translateY(-2px); background:#12203f; border-color:rgba(255,255,255,.22) }
.theme-toggle:active{ transform:translateY(0) }

/* escenario */
.graph-stage{
  position:relative;
  border:1px solid rgba(255,255,255,.06);
  border-radius:12px;
  background:#0c1323;
  overflow:hidden;
  height:680px;
}

/* breadcrumb (opcional) */
.graph-bc{
  position:absolute; left:12px; top:10px; z-index:3;
  display:flex; gap:10px; align-items:center; padding:4px 8px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(8,14,25,.5); backdrop-filter: blur(3px);
  border-radius:999px; color:var(--muted); font-size:13px;
  opacity:0; transform:translateY(-6px); transition:opacity .24s ease, transform .24s ease;
}
.graph-bc.bc-in{ opacity:1; transform:none; }
.graph-bc .crumb{
  cursor:pointer; font-weight:700; color:#cfe6ff; position:relative;
  background: linear-gradient(currentColor, currentColor) 0 100% / 0 2px no-repeat;
  transition: background-size .12s ease;
}
.graph-bc .crumb:hover{ background-size: 100% 2px; }
.graph-bc .sep{ opacity:.6 }

/* CAPA DE PARTÍCULAS (decorativa, no interactiva) */
.graph-stage .ambient-canvas{
  position:absolute; inset:0; width:100%; height:100%;
  pointer-events:none; z-index:0;
}

/* SVG ocupa todo y queda por encima del canvas */
#graphSvg{ width:100%; height:100%; display:block; position:relative; z-index:1; }

/* leyenda */
.graph-legend{
  display:flex; gap:14px; align-items:center; justify-content:flex-end; margin-top:10px;
  color:var(--muted); font-size:13px;
}
.graph-legend .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; box-shadow:0 0 10px rgba(0,0,0,.25) }
.graph-legend .lvl0{ background:var(--accent) }
.graph-legend .lvl1{ background:#ffd79a }
.graph-legend .lvl2{ background:#8fd6ff }
.graph-legend .lvl3{ background:#9be2b0 }

/* ===== Nodos ===== */
.node{ cursor:pointer; opacity:1; }
.node rect{
  rx:10; ry:10; fill:#0e1730; stroke:rgba(255,255,255,.10); stroke-width:1.2;
}
.node .title{
  fill:#e9eef6; font-weight:800; font-size:13.8px; letter-spacing:.1px;
  text-rendering:geometricPrecision;
}
.node[data-lvl="2"] .title{ font-size:13.2px; }
.node[data-lvl="3"] .title{ font-size:12.8px; }
.node .sub{   fill:#a8b2c2; font-size:12.4px; text-rendering:geometricPrecision; }
.node .badge{
  fill:#07101a; font-weight:900; font-size:11px;
  text-anchor:middle; dominant-baseline:middle; pointer-events:none;
}

/* Borde + glow por nivel (paleta del sitio) */
.node[data-lvl="0"] rect{
  fill:rgba(255,159,26,.18); stroke:rgba(255,159,26,.55);
  filter: drop-shadow(0 0 10px rgba(255,159,26,.12)) drop-shadow(0 0 20px rgba(255,159,26,.08));
}
.node[data-lvl="1"] rect{
  fill:rgba(255,215,154,.12); stroke:rgba(255,215,154,.5);
  filter: drop-shadow(0 0 10px rgba(255,215,154,.10)) drop-shadow(0 0 18px rgba(255,215,154,.06));
}
.node[data-lvl="2"] rect{
  fill:rgba(143,214,255,.10); stroke:rgba(143,214,255,.45);
  filter: drop-shadow(0 0 10px rgba(143,214,255,.10)) drop-shadow(0 0 18px rgba(143,214,255,.06));
}
.node[data-lvl="3"] rect{
  fill:rgba(155,226,176,.10); stroke:rgba(155,226,176,.4);
  filter: drop-shadow(0 0 10px rgba(155,226,176,.10)) drop-shadow(0 0 18px rgba(155,226,176,.06));
}

/* ==== ENTRADA SUTIL (ajustable) ==== */
.node .node-in{
  opacity:0;
  transform: translateY(8px);
  will-change: transform, opacity;
}
.node.is-in .node-in{
  animation: node-in-smooth .81s cubic-bezier(.2,.8,.2,1) forwards;
}
@keyframes node-in-smooth{
  from { opacity:0; transform: translateY(8px); }
  to   { opacity:1; transform: translateY(0); }
}

/* ===== Pulso de confirmación al seleccionar ===== */
.node.confirm rect{
  animation: node-confirm 0.16s cubic-bezier(.22,.61,.36,1) 1;
}
@keyframes node-confirm{
  0%   { stroke-width:1.2; filter: drop-shadow(0 0 10px rgba(255,159,26,.12)); }
  50%  { stroke-width:2.2; filter: drop-shadow(0 0 14px rgba(255,159,26,.22)); }
  100% { stroke-width:1.2; filter: drop-shadow(0 0 10px rgba(255,159,26,.12)); }
}

/* Hover y foco */
.node.moving{ transition: transform .55s cubic-bezier(.2,.8,.2,1); }
.node.focus rect{ stroke-width:1.8; filter: drop-shadow(0 0 14px rgba(255,159,26,.18)); }
.node rect{ transition:filter .2s ease, stroke-width .18s ease; }
.node.hovered rect{ filter:drop-shadow(0 0 14px rgba(255,159,26,.18)); stroke-width:1.6; }

/* ===== Estados de iluminación ===== */
.sleep{ opacity:.18; filter:grayscale(.55); transition:opacity .24s ease, filter .24s ease; }
.link.sleep{ animation-play-state: paused; }

/* Encender panel entero */
.graph-stage.panel-on .sleep{ opacity:1 !important; filter:none !important; }
.graph-stage.panel-on .link.sleep{ animation-play-state: running !important; }

/* ===== Ruta viva (enlaces activos) ===== */
/* Añadimos gradiente direccional sutil (izq→der). */
.link.breathe{
  stroke: url(#linkGrad);
  animation: link-breathe 4.5s ease-in-out infinite, flow 10s linear infinite;
}
body.theme-tech .link.breathe{
  stroke: url(#linkGradTech);
}
@keyframes link-breathe{
  0%,100%{ filter: drop-shadow(0 0 4px rgba(255,159,26,.12)); opacity:.75; }
  50%{    filter: drop-shadow(0 0 10px rgba(255,159,26,.22)); opacity:1; }
}
.link.pulse-once{
  animation: link-pulse .9s cubic-bezier(.22,.61,.36,1) 1, flow 10s linear infinite;
}
@keyframes link-pulse{
  0%{   stroke-width:2; }
  30%{  stroke-width:3.6; }
  100%{ stroke-width:2; }
}

/* Atenuación clásica */
.dim-node{ opacity:.34; }
.dim-link{ opacity:.28; }

/* ===== Enlaces ===== */
.link{
  fill:none;
  stroke:rgba(255,159,26,.55);
  stroke-width:2;
  filter: drop-shadow(0 0 4px rgba(255,159,26,.16));
}
.link.l1{ stroke:rgba(255,215,154,.55) }
.link.l2{ stroke:rgba(143,214,255,.55) }
.link.l3{ stroke:rgba(155,226,176,.55) }

/* aparición del trazo y flujo */
.link.draw{
  stroke-dasharray: 600;
  stroke-dashoffset: 600;
  animation: draw 1.5s ease forwards;
}
@keyframes draw{ to{ stroke-dashoffset:0 } }

.link.flow{
  stroke-dasharray: 10 8;
  animation: flow 10s linear infinite;
}
@keyframes flow{ to { stroke-dashoffset: -18; } }

/* flash corto */
.link.flash{ filter: drop-shadow(0 0 8px rgba(255,255,255,.25)); }

/* ====== BÚSQUEDA (overlay) ====== */
.graph-search{
  position:absolute; top:16px; right:16px; z-index:4;
  display:none; align-items:center; gap:8px;
  background: rgba(10,16,28,.85); backdrop-filter: blur(6px);
  border:1px solid rgba(255,255,255,.12); border-radius:10px;
  padding:8px 10px;
}
.graph-search.show{ display:flex; }
.graph-search input{
  background:transparent; border:none; outline:none;
  color:#e9eef6; font-weight:700; font-size:14px; width:220px;
}
.graph-search .hint{ color:#9db3d4; font-size:12px; }

/* Resaltar resultados / atenuar no coincidentes */
.search-hit .title{ fill:#ffffff; }
.search-dim{ opacity:.12 !important; filter:grayscale(.75); }
.link.search-dim{ animation-play-state: paused; }

/* Cursores para pan/zoom */
.graph-stage.is-panning{ cursor:grabbing; }
.graph-stage .svgroot{ cursor:grab; }

/* ===================== THEME: modo técnico (verde) ===================== */
body.theme-tech{
  --bg:#050a08; --panel:#0a1410; --text:#e5ffe9; --muted:#9fe0b0;
  --accent:#00e676; --accent-soft:#82ffbe;
}
body.theme-tech .graph-stage{ background:#07110d; }
body.theme-tech .graph-bc{ background:rgba(6,14,10,.6); }
body.theme-tech .theme-toggle{ background:#09160f; border-color:rgba(0,230,118,.25); }
body.theme-tech .theme-toggle:hover{ background:#0b1d15; }

body.theme-tech .graph-legend .lvl0{ background:#00e676 }
body.theme-tech .graph-legend .lvl1{ background:#b3ffd5 }
body.theme-tech .graph-legend .lvl2{ background:#77ffd0 }
body.theme-tech .graph-legend .lvl3{ background:#a8ffc6 }

body.theme-tech .node[data-lvl="0"] rect{ fill:rgba(0,230,118,.16); stroke:rgba(0,230,118,.6); filter: drop-shadow(0 0 12px rgba(0,230,118,.16)) drop-shadow(0 0 22px rgba(0,230,118,.10)); }
body.theme-tech .node[data-lvl="1"] rect{ fill:rgba(131,255,199,.12); stroke:rgba(131,255,199,.52); }
body.theme-tech .node[data-lvl="2"] rect{ fill:rgba(119,255,208,.10); stroke:rgba(119,255,208,.45); }
body.theme-tech .node[data-lvl="3"] rect{ fill:rgba(168,255,198,.10); stroke:rgba(168,255,198,.42); }

body.theme-tech .link{ stroke:rgba(0,230,118,.6); filter: drop-shadow(0 0 5px rgba(0,230,118,.18)); }
body.theme-tech .link.l1{ stroke:rgba(131,255,199,.6) }
body.theme-tech .link.l2{ stroke:rgba(119,255,208,.6) }
body.theme-tech .link.l3{ stroke:rgba(168,255,198,.6) }

/* Responsive */
@media (max-width: 960px){ .graph-stage{ height:520px; } }
@media (max-width: 640px){ .graph-stage{ height:420px; } }

/* Reduce motion */
@media (prefers-reduced-motion: reduce){
  .link.draw{ animation:none; stroke-dasharray:0; stroke-dashoffset:0; }
  .node, .node .node-in{ transition:none; animation:none; transform:none; opacity:1; }
  .link.breathe, .link.pulse-once{ animation:none; }
  .node.moving{ transition:none; }
}

